# Bitbucket CLI for Claude Code

A powerful command-line interface for managing Bitbucket pull requests, designed specifically for seamless integration with Claude Code development workflows.

[![CI](https://github.com/ethandrower/bitbucket-cli-claude-code/workflows/CI/badge.svg)](https://github.com/ethandrower/bitbucket-cli-claude-code/actions)
[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)
[![Code style: black](https://img.shields.io/badge/code%20style-black-000000.svg)](https://github.com/psf/black)

**ABOUTME: Lightweight Python CLI tool for managing Bitbucket Cloud pull requests using REST API v2.0**  
**ABOUTME: Designed specifically for integration with Claude Code workflows and automated PR reviews**

## Features

- ✅ Create, list, and manage pull requests
- ✅ Approve, decline, and merge PRs with custom strategies  
- ✅ Add inline comments on specific lines and ranges
- ✅ Interactive review sessions with guided workflows
- ✅ Git integration for auto-detection of repository context
- ✅ Batch operations for multiple PRs
- ✅ JSON output for programmatic use
- ✅ Real-time pagination handling
- ✅ Secure authentication with app passwords

## Quick Start

### Installation

#### From GitHub (Recommended)

```bash
git clone https://github.com/ethandrower/bitbucket-cli-claude-code.git
cd bitbucket-cli-claude-code
pip install -e .
```

#### Direct Installation

```bash
pip install git+https://github.com/ethandrower/bitbucket-cli-claude-code.git
```

### Authentication Setup

**Method 1: Repository Access Token (Recommended)**
1. Go to your repository → Settings → Access tokens
2. Create a new token with "Repositories: Write" permission
3. Configure the CLI:

```bash
bb-pr config --repo-token your-repo-token --workspace your-workspace
# OR set environment variable:
export BITBUCKET_REPO_TOKEN="your-repo-token"
```

**Method 2: App Password (Alternative)**
1. Create an app password at: https://bitbucket.org/account/settings/app-passwords/
2. Configure the CLI:

```bash
bb-pr config --username your-username --app-password your-app-password --workspace your-workspace
```

### Basic Usage

```bash
# Create a pull request
bb-pr create --title "Feature: Add authentication" --description "Implements OAuth2"

# List open PRs
bb-pr list

# Review a PR with inline comments
bb-pr comment 123 --file src/auth.py --line 42 --message "Consider using bcrypt"

# Approve and merge
bb-pr approve 123
bb-pr merge 123 --strategy squash --close-branch
```

## Command Reference

### PR Management

- `bb-pr create` - Create a new pull request
- `bb-pr list` - List pull requests with filtering
- `bb-pr show <id>` - View detailed PR information
- `bb-pr update <id>` - Update PR title, description, or reviewers

### Review Actions

- `bb-pr approve <id>` - Approve a pull request
- `bb-pr unapprove <id>` - Remove your approval
- `bb-pr decline <id>` - Decline/close a pull request
- `bb-pr comment <id>` - Add comments (general or inline)

### Merge Operations

- `bb-pr merge <id>` - Merge with various strategies (merge_commit, squash, fast_forward)

### Utilities

- `bb-pr diff <id>` - View PR diff
- `bb-pr activity <id>` - View PR activity timeline
- `bb-pr config` - Manage authentication and defaults

## Claude Code Integration

This CLI is designed to work seamlessly with Claude Code for automated PR workflows:

### Automated Review Comments
```python
# Claude Code can use this CLI to add structured review comments
import subprocess

review_comments = [
    {"file": "src/auth.py", "line": 42, "message": "Security: Use bcrypt for password hashing"},
    {"file": "src/api.py", "line": 15, "message": "Error handling: Add try-catch block"}
]

for comment in review_comments:
    subprocess.run([
        "bb-pr", "comment", str(pr_id),
        "--file", comment["file"],
        "--line", str(comment["line"]),
        "--message", comment["message"]
    ])
```

### Programmatic Usage
```python
from bitbucket_cli.api import BitbucketAPI
from bitbucket_cli.auth import load_config

# Initialize API client
config = load_config()
api = BitbucketAPI(config)

# Create PR programmatically  
pr = api.create_pull_request(
    title="Automated feature update",
    description="Generated by Claude Code",
    source_branch="feature/auto-update",
    destination_branch="main"
)

# Add review comments
api.add_comment(pr["id"], "Great work on this feature!", inline={
    "file": "src/main.py",
    "line": 25
})
```

## API Compatibility

Built for **Bitbucket Cloud** REST API v2.0 (`api.bitbucket.org/2.0`).

⚠️ **Note**: This tool is NOT compatible with Bitbucket Server/Data Center (which uses v1.0 API).

## Configuration

Configuration is stored in `~/.bitbucket-cli/config.yaml`:

```yaml
auth:
  repo_token: your-repository-token  # Preferred method
  workspace: your-workspace
  
  # Alternative authentication (fallback)
  username: your-username
  app_password: your-app-password

defaults:
  reviewers: [user1, user2]
  delete_source_branch: true
  merge_strategy: squash
  default_branch: main

api:
  base_url: https://api.bitbucket.org/2.0
  timeout: 30
  retries: 3
```

**Environment Variables** (take precedence over config file):
```bash
export BITBUCKET_REPO_TOKEN="your-repo-token"         # Primary
export BITBUCKET_WORKSPACE="your-workspace"
export BITBUCKET_USERNAME="your-username"             # Fallback  
export BITBUCKET_APP_PASSWORD="your-app-password"     # Fallback
```

## Examples

### Standard Development Workflow
```bash
# 1. Create feature branch and PR
git checkout -b feature/new-auth
git commit -am "Add OAuth2 authentication"
git push -u origin feature/new-auth

bb-pr create \
  --title "Feature: OAuth2 Authentication" \
  --description "Implements secure OAuth2 flow with refresh tokens" \
  --source feature/new-auth \
  --dest main \
  --reviewers alice,bob

# 2. Add review comments
bb-pr comment 123 --file src/auth.py --line 25 \
  --message "Consider adding rate limiting here"

bb-pr comment 123 --file src/auth.py --from-line 40 --to-line 45 \
  --message "This error handling block needs improvement"

# 3. Approve and merge
bb-pr approve 123
bb-pr merge 123 --strategy squash --message "Add OAuth2 authentication system" --close-branch
```

### Interactive Review Session
```bash
# Start guided review with prompts
bb-pr review 123 --interactive
```

### Batch Operations
```bash
# List all PRs I need to review
bb-pr list --reviewer $(bb-pr config --get username) --state OPEN

# Get PR data as JSON for processing
bb-pr list --json | python -c "
import json, sys
prs = json.load(sys.stdin)
for pr in prs:
    if 'security' in pr['title'].lower():
        print(f'Security PR: {pr[\"id\"]} - {pr[\"title\"]}')
"
```

## Error Handling

The CLI provides clear error messages for common issues:

- **401 Unauthorized**: Check your app password and username
- **403 Forbidden**: Insufficient repository permissions  
- **404 Not Found**: Repository or PR doesn't exist
- **409 Conflict**: PR already merged or has conflicts
- **429 Rate Limited**: Wait and retry (1000 requests/hour limit)

## Development

```bash
# Clone and setup
git clone https://bitbucket.org/citemed/bitbucket-cli-for-claude-code.git
cd bitbucket-cli-for-claude-code

# Install in development mode
pip install -e ".[dev]"

# Run tests
pytest

# Run with development flags
bb-pr --help
```

## Contributing

1. Follow the existing code patterns
2. Add tests for new functionality  
3. Update documentation
4. Ensure all pre-commit hooks pass

## License

MIT License - See LICENSE file for details.

---

Built with ❤️ for the CiteMed development team and Claude Code integration.